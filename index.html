<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reaction Time Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
      background: #f4f4f4;
    }

    .container {
      max-width: 500px;
      margin: auto;
      padding: 20px;
    }

    #test-area {
      background-color: #ddd;
      height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5em;
      margin: 20px 0;
      border-radius: 12px;
    }

    button {
      padding: 15px 25px;
      font-size: 16px;
      margin: 10px;
      border: none;
      border-radius: 8px;
      background-color: #007BFF;
      color: white;
      cursor: pointer;
    }

    input {
      padding: 10px;
      font-size: 1em;
      margin: 5px;
      width: 90%;
      max-width: 300px;
      border-radius: 6px;
      border: 1px solid #aaa;
    }

    #results {
      margin-top: 20px;
      text-align: left;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Reaction Time Test</h1>
    <p>Enter your details to begin:</p>
    <input id="name" placeholder="Name" /><br />
    <input id="age" type="number" placeholder="Age" /><br />
    <input id="sex" placeholder="Sex (M/F/Other)" /><br />
    <button onclick="startVisual()">Start Visual Test</button>
    <button onclick="startAudio()">Start Audio Test</button>

    <div id="test-area">Instructions will appear here</div>

    <div id="results"></div>
  </div>

  <audio id="beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" loop></audio>

  <script>
    const testArea = document.getElementById("test-area");
    const resultsDiv = document.getElementById("results");
    const beep = document.getElementById("beep");

    let visualTimes = [];
    let audioTimes = [];
    let currentType = ""; // "visual" or "audio"
    let testCount = 0;
    let startTime;

    function showInstructions(message) {
      testArea.innerText = message;
      testArea.style.backgroundColor = "#ddd";
    }

    function startVisual() {
      if (!getUserInfo()) return;
      currentType = "visual";
      testCount = 0;
      visualTimes = [];
      showInstructions("You will see a color flash. Tap as quickly as possible!");
      setTimeout(runTest, 2000);
    }

    function startAudio() {
      if (!getUserInfo()) return;
      currentType = "audio";
      testCount = 0;
      audioTimes = [];
      showInstructions("You will hear a beep. Tap as quickly as possible!");
      setTimeout(runTest, 2000);
    }

    function runTest() {
      let delay = Math.random() * 3000 + 1000; // 1s–4s random delay
      showInstructions("Wait for it...");
      setTimeout(() => {
        startTime = Date.now();

        if (currentType === "visual") {
          testArea.innerText = "TAP NOW!";
          testArea.style.backgroundColor = "#4CAF50";
        } else {
          testArea.innerText = "Audio cue playing… TAP!";
          beep.play();
        }

        testArea.addEventListener("click", recordReaction, { once: true });
        testArea.addEventListener("touchstart", recordReaction, { once: true });
      }, delay);
    }

    function recordReaction() {
      let time = Date.now() - startTime;

      if (currentType === "visual") {
        visualTimes.push(time);
        testArea.style.backgroundColor = "#ddd";
      } else {
        audioTimes.push(time);
        beep.pause();
        beep.currentTime = 0;
      }

      testCount++;

      if (testCount < 5) {
        setTimeout(runTest, 1000);
      } else {
        showInstructions("Done! Calculating...");
        setTimeout(showResults, 1000);
      }
    }

    function showResults() {
      let avgVisual = average(visualTimes);
      let avgAudio = average(audioTimes);
      let resultHTML = `<h2>Results</h2>`;
      resultHTML += `<p><strong>Name:</strong> ${name.value}</p>`;
      resultHTML += `<p><strong>Age:</strong> ${age.value}</p>`;
      resultHTML += `<p><strong>Sex:</strong> ${sex.value}</p>`;
      resultHTML += `<p><strong>Visual times (ms):</strong> ${visualTimes.join(", ")}</p>`;
      resultHTML += `<p><strong>Average visual reaction time:</strong> ${avgVisual.toFixed(2)} ms</p>`;
      resultHTML += `<p><strong>Audio times (ms):</strong> ${audioTimes.join(", ")}</p>`;
      resultHTML += `<p><strong>Average audio reaction time:</strong> ${avgAudio.toFixed(2)} ms</p>`;
      resultsDiv.innerHTML = resultHTML;

      sendToGoogleSheet({
        name: name.value,
        age: age.value,
        sex: sex.value,
        visualTimes: visualTimes,
        audioTimes: audioTimes,
        avgVisual: avgVisual.toFixed(2),
        avgAudio: avgAudio.toFixed(2),
      });
    }

    function average(arr) {
      return arr.reduce((a, b) => a + b, 0) / arr.length;
    }

    function getUserInfo() {
      if (!name.value || !age.value || !sex.value) {
        alert("Please enter your name, age, and sex.");
        return false;
      }
      return true;
    }

    function sendToGoogleSheet(data) {
      fetch("https://script.google.com/macros/s/AKfycbzbdvJmThNP4RacCKd746sEdmTgF8unGX6Y3a9ft-Bof_U5mBXYIN5zziLCBFZ_8R1jhQ/exec", {
        method: "POST",
        body: JSON.stringify(data),
        headers: {
          "Content-Type": "application/json"
        }
      })
      .then(res => console.log("Submitted to Google Sheet"))
      .catch(err => console.error("Error sending data:", err));
    }
  </script>
</body>
</html>
